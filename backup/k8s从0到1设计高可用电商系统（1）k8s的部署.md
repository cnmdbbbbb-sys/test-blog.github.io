# 第一步：系统初始化
K8s 对系统环境要求很严，必须关闭 Swap 和配置内核转发。
1. 关闭 Swap 
```
swapoff -a
sed -ri 's/.*swap.*/#&/' /etc/fstab
```

2. 配置内核转发 (让流量可以在 Pod 之间转发)
```
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system
```
# 第二步：安装 Containerd（容器运行时）
 K8s 现在标准推荐 Containerd。

1. 安装依赖
`apt-get update && apt-get install -y apt-transport-https ca-certificates curl`

2. 下载并安装 Containerd 
`apt-get install -y containerd`

3. 生成默认配置文件并修改（配置阿里云镜像加速，防止拉取镜像失败）
```
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml
```

4. 修改 sandbox_image 地址为阿里云 (解决 k8s.gcr.io 无法访问)
```
sed -i 's/registry.k8s.io\/pause:3.6/registry.aliyuncs.com\/google_containers\/pause:3.9/g' /etc/containerd/config.toml
sed -i 's/registry.k8s.io\/pause:3.8/registry.aliyuncs.com\/google_containers\/pause:3.9/g' /etc/containerd/config.toml
```

5. 配置 SystemdCgroup (K8s 推荐)
`sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml`

6. 重启 containerd
```
systemctl restart containerd
systemctl enable containerd
```
# 第三步：安装 Kubeadm、Kubelet、Kubectl
这是 K8s 的核心三件套。
1. 添加阿里云的 K8s apt 源
```
curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF
```

2. 安装工具 (指定版本，防止版本过新导致不兼容，这里选稳健的 1.28 版本)
```
apt-get update
apt-get install -y kubelet=1.28.2-00 kubeadm=1.28.2-00 kubectl=1.28.2-00
```

3. 锁定版本防止自动更新
`apt-mark hold kubelet kubeadm kubectl`
# 第四步：初始化集群（核心步骤）
注意：因为在本地，且只有一台机器，需要明确指定 IP 和镜像源。
1. 初始化 Master 节点 
```
kubeadm init \
  --apiserver-advertise-address=${APISERVER_IP} \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.28.2 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16
```

2. 配置 kubectl 
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

3. 安装网络插件 Calico (必须安装，否则 Node 状态会一直是 NotReady)
```
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/custom-resources.yaml
```
# 第五步：解除单机限制（关键！）
默认情况下，K8s 不会让 Master 节点运行业务 Pod。但你只有一台机器，所以必须解除这个限制（Taint）。

去除污点，允许 Master 节点部署 Pod
`kubectl taint nodes --all node-role.kubernetes.io/control-plane-`
# 验证时刻
```
kubectl get nodes
kubectl get pods -A
```
